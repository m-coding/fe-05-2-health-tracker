/**! Nutrition Tracker App
 * @namespace {object} nt */
var nt={Models:{},Collections:{},Views:{},Router:{},Plugin:{},Option:{},preloader:'<div class="spinnerContainer">Loading <div class="spinner"></div> Please Wait'};nt.Models.Food=Backbone.Model.extend({defaults:{id:"",sortOrder:0,name:"",fat:0,carbs:0,protein:0,calories:0,servingSize:0,servingUnit:""},parse:function(e){if("undefined"!=typeof e.fields){var t={};return t.id=e._id,t.name=e.fields.item_name,t.calories=e.fields.nf_calories,t.fat=e.fields.nf_total_fat,t.carbs=e.fields.nf_total_carbohydrate,t.protein=e.fields.nf_protein,t.servingSize=e.fields.nf_serving_size_qty,t.servingUnit=e.fields.nf_serving_size_unit,t}return e}}),nt.Models.Recipe=Backbone.Model.extend({defaults:{id:"",recipeImage:"",recipeTitle:"",numCalories:"",numIngredients:"",siteIcon:"",siteTitle:"",siteLink:""},parse:function(e){var t=e.recipe.uri.indexOf("_")+1,i="http://www.edamam.com/http/",r="images/icon.png";e.recipe.sourceIcon&&(r=e.recipe.sourceIcon.replace("http://",i));var a={};return a.id=e.recipe.uri.slice(t),a.recipeImage=e.recipe.image,a.recipeTitle=e.recipe.label,a.numCalories=parseInt(e.recipe.calories/e.recipe["yield"],10),a.numIngredients=e.recipe.ingredientLines.length,a.siteIcon=r,a.siteTitle=e.recipe.source,a.siteLink=e.recipe.shareAs,a}}),nt.Models.Nutrition=Backbone.Model.extend({defaults:function(){return{width:280,id:"",itemName:"",servingCount:1,moreThanOne:!1,showPolyFat:!1,showMonoFat:!1,showIngredients:!1,valueServingSize:0,valueServingSizeUnit:"",valueCalories:0,valueFatCalories:0,valueTotalFat:0,valueSatFat:0,valueTransFat:0,valueCholesterol:0,valueSodium:0,valueTotalCarb:0,valueFibers:0,valueSugars:0,valueProteins:0,valueVitaminA:0,valueVitaminC:0,valueCalcium:0,valueIron:0}},url:"https://api.nutritionix.com/v1_1/item/",parse:function(e){if(e.hasOwnProperty("item_id")){var t={};return t.width=280,t.id=e.item_id,t.itemName=e.item_name,t.servingCount=1,t.moreThanOne=!1,t.showPolyFat=!1,t.showMonoFat=!1,t.showIngredients=!1,t.valueServingSize=e.nf_serving_size_qty,t.valueServingSizeUnit=e.nf_serving_size_unit,t.valueCalories=e.nf_calories,t.valueFatCalories=e.nf_calories_from_fat,t.valueTotalFat=e.nf_total_fat,t.valueSatFat=e.nf_saturated_fat,t.valueTransFat=e.nf_trans_fatty_acid,t.valueCholesterol=e.nf_cholesterol,t.valueSodium=e.nf_sodium,t.valueTotalCarb=e.nf_total_carbohydrate,t.valueFibers=e.nf_dietary_fiber,t.valueSugars=e.nf_sugars,t.valueProteins=e.nf_protein,t.valueVitaminA=e.nf_vitamin_a_dv,t.valueVitaminC=e.nf_vitamin_c_dv,t.valueCalcium=e.nf_calcium_dv,t.valueIron=e.nf_iron_dv,t}return e},validate:function(e,t){if(e.hasOwnProperty("trackDate")){if(""===e.trackDate)return"Date cannot be blank.";var i=moment(e.trackDate,"YYYY-MM-DD",!0).isValid();if(!i)return"Date must be in YYYY-MM-DD format."}return""===e.itemName?"Food name cannot be blank.":void 0},valueUpdate:function(e,t){var i=["valueCalories","valueFatCalories","valueTotalFat","valueSatFat","valueTransFat","valueCholesterol","valueSodium","valueTotalCarb","valueFibers","valueSugars","valueProteins","valueVitaminA","valueVitaminC","valueCalcium","valueIron"],r=_.pick(e,i),a=0,s="",n=0;for(s in r)a=r[s],a&&(n=a*t,Number.isInteger(n)?r[s]=n:r[s]=Number(n).toFixed(2));t>1?r.moreThanOne=!0:r.moreThanOne=!1,r.servingCount=t,this.set(r)}}),nt.Models.Autocomplete=Backbone.Model.extend({defaults:{id:"",text:""}}),nt.Collections.FoodSearch=Backbone.Collection.extend({model:nt.Models.Food,searchPhrase:"",url:function(){return"https://api.nutritionix.com/v1_1/search/"+this.searchPhrase},parse:function(e){return e.hits},nextOrder:function(){return this.length?this.last().get("sortOrder")+1:1},comparator:function(e){return e.get("sortOrder")}}),nt.Collections.RecipeSearch=Backbone.Collection.extend({model:nt.Models.Recipe,url:"https://api.edamam.com/search",sync:function(e,t,i){return i.dataType="jsonp",Backbone.sync(e,t,i)},parse:function(e){return e.hits}}),nt.Collections.NutritionTracker=Backbone.Collection.extend({model:nt.Models.Nutrition,localStorage:new Backbone.LocalStorage("nutrition-tracker"),initialize:function(){nt.Option.trackerDate=moment(new Date).format("YYYY-MM-DD"),nt.Option.displayAll=!1},nextOrder:function(){return this.length?this.last().get("sortOrder")+1:1},comparator:function(e){return e.get("sortOrder")},getModelsByDate:function(){var e=this.where({trackDate:nt.Option.trackerDate}),t=new Backbone.Collection(e);return t},calculateSum:function(e){var t=this,i=0;return this.length?(nt.Option.displayAll||(t=this.getModelsByDate()),i=t.reduce(function(t,i){return Number(t)+Number(i.get(e)*i.get("servingCount"))},0),Number.isInteger(i)?i:Number(i).toFixed(2)):void 0}}),nt.Collections.AutocompleteSearch=Backbone.Collection.extend({model:nt.Models.Autocomplete,url:"https://apibeta.nutritionix.com/v2/autocomplete",api:{q:"",appId:"53242d79",appKey:"82289438a16ec7b92cdcf5ad054159c4"},apiError:function(e,t){var i=t.status+" "+t.statusText+" : Autocomplete server request error. <br> Please try again.";window.console&&console.log(i),$("#search-suggest .dropdown-menu").show().html('<li class="typeahead-error"><a>'+i+"</a></li>")},fetch:function(){return this.trigger("fetch",this),Backbone.Model.prototype.fetch.apply(this,arguments)}}),nt.Views.Start=Backbone.View.extend({el:"#start-screen",events:{"click .btn-success":"startSearch"},showStart:function(){this.$el.show(),$("#app").hide()},hideStart:function(){this.$el.hide(),$("#app").show()},startSearch:function(){nt.Router.Instance["goto"]("search")}}),nt.Views.TabNav=Backbone.View.extend({initialize:function(){$("#app-tabs a").click(function(e){e.preventDefault(),$(this).tab("show"),$(".row").eqHeights({child:".eqHeights"})})}}),nt.Views.Search=Backbone.View.extend({el:"#search-top",prevQuery:"",itemTemplate:Handlebars.compile($("#item-template").html()),events:{"click #search-help":"toggleHelp","click #search-help-text .close":"toggleHelp","click #search-clear":"clearSearch","submit #search-suggest":"noSubmit"},initialize:function(){_.bindAll(this,"searchSuccess","searchError"),this.$searchTop=$("#search-top"),this.$searchResults=$("#search-results"),this.$searchFood=$("#search-food"),this.$help=$("#search-help-text"),this.$dropmenu=$("#search-suggest .dropdown-menu"),this.listenTo(nt.Plugin.Instance,"selected",this.searchFood)},render:function(){return this.$searchResults.html(""),this.$searchResults.append(this.itemTemplate({items:this.collection.toJSON()})),this},toggleHelp:function(){this.$help.toggle()},renderNoResults:function(){var e=this.$searchFood.val(),t='<div class="alert alert-info">Could not find any foods containing: '+e+"</div>";this.$searchResults.html(t)},searchSuccess:function(e,t){0===t.total_hits?this.renderNoResults():this.render()},searchError:function(e,t){var i=t.status,r=t.statusText,a='<div class="alert alert-danger">Nutritionix search request failed with error: <br>'+i+" : "+r+"</div>";this.$searchResults.html(a)},searchFood:function(){var e=this.$searchFood.val().trim(),t={results:"0:10",fields:"item_name,nf_calories,nf_total_fat,nf_total_carbohydrate,nf_protein,nf_serving_size_qty,nf_serving_size_unit",appId:"53242d79",appKey:"82289438a16ec7b92cdcf5ad054159c4"};this.$searchResults.html(nt.preloader),e.length>0?(this.collection.reset(),this.collection.searchPhrase=e,this.collection.fetch({data:$.param(t),success:this.searchSuccess,error:this.searchError})):this.$searchResults.html(""),nt.Router.Instance.navigate("search/"+e)},noSubmit:function(e){e.preventDefault()},clearSearch:function(){this.$searchFood.val(""),this.$searchResults.html(""),nt.Plugin.Instance.hide()}}),nt.Views.Recipe=Backbone.View.extend({el:"#search",recipeTemplate:Handlebars.compile($("#recipe-template").html()),events:{"click #recipe-open":"openRecipes","click #recipe-close":"closeRecipes"},initialize:function(){_.bindAll(this,"recipeSuccess","recipeError"),this.$searchTop=$("#search-top"),this.$searchResults=$("#search-results"),this.$recipeTop=$("#recipe-top"),this.$recipeResults=$("#recipe-results"),this.$recipeResults.html(nt.preloader)},render:function(){return this.$recipeResults.html(""),this.$recipeResults.append(this.recipeTemplate({recipes:this.collection.toJSON()})),this},recipeSuccess:function(e,t){this.render()},recipeError:function(e,t){var i=t.status,r=t.statusText,a='<div class="alert alert-danger">Edamam recipe request failed with error: <br>'+i+" : "+r+"</div>";this.$recipeResults.html(a)},getRecipes:function(e){var t={q:e,app_id:"109142f6",app_key:"21467cc06c5f05e55b19271dcc457914",to:"5"};this.collection.reset(),this.collection.fetch({data:$.param(t),success:this.recipeSuccess,error:this.recipeError})},openRecipes:function(){var e=$("#search-food").val();this.getRecipes(e),this.$searchTop.hide(),this.$searchResults.hide(),this.$recipeTop.show(),this.$recipeResults.show()},closeRecipes:function(){this.$recipeResults.html(""),this.$recipeTop.hide(),this.$searchTop.show(),this.$recipeResults.hide(),this.$searchResults.show()}}),nt.Views.Nutrition=Backbone.View.extend({el:"#app",buttonsTemplate:Handlebars.compile($("#buttons-template").html()),events:{"click .item-nutrition":"openNutrition","click #nutrition-close":"closeNutrition","click #nutrition-add":"addFood","click #nutrition-remove":"removeFood","click #nutrition-track":"openTrackerView"},initialize:function(){_.bindAll(this,"itemSuccess","itemError"),this.$nutrition=$("#nutrition"),this.$nutritionTop=$("#nutrition-top"),this.$nutritionMenu=$("#nutrition-button-menu"),this.$nutritionResults=$("#nutrition-results"),this.$nLabel=$("#nlabel"),this.trackedItem=null,this.gchart=null,this.gformat=null,google.charts.load("current",{packages:["corechart"]}),this.listenTo(nt.Plugin.Instance,"selected",this.closeNutrition),this.listenTo(this.model,"foodsaved",this.updateView)},render:function(){this.displayMenu(),this.displayChart(),this.displayNutrition()},showColumn:function(){this.$nutrition.removeClass("hideColumn")},hideColumn:function(){this.$nutrition.addClass("hideColumn")},openNutrition:function(e){var t=$(e.target),i=t.data("item");e.preventDefault(),this.closeNutrition(),t.closest(".item").css("background-color","#b8dec0").addClass("highlight"),this.showColumn(),this.checkItem(i)},checkItem:function(e){this.trackedItem=nt.Collections.tracker.get(e),this.trackedItem?(this.model.set(this.trackedItem.toJSON()),this.itemSuccess()):this.getNutrition(e)},closeNutrition:function(){$(".highlight").removeAttr("style").removeClass("highlight"),this.$nutritionResults.find("figure").html(""),this.hideColumn(),$(".tracked-delete").show()},itemSuccess:function(e,t){this.render(),$(".row").eqHeights({child:".eqHeights"})},itemError:function(e,t){var i=t.status,r=t.statusText,a='<div class="alert alert-danger">Nutritionix item request failed: <br>'+i+" : "+r+"</div>";this.$nutritionMenu.html(a)},getNutrition:function(e){var t={id:e,appId:"53242d79",appKey:"82289438a16ec7b92cdcf5ad054159c4"};this.$nutritionMenu.html(nt.preloader),this.model.clear(),this.model.fetch({data:$.param(t),success:this.itemSuccess,error:this.itemError})},displayChart:function(){var e=this.model.get("valueTotalFat"),t=this.model.get("valueTotalCarb"),i=this.model.get("valueProteins"),r=google.visualization.arrayToDataTable([["Nutrient","Value"],["Fat",e],["Carbs",t],["Protein",i]]),a={width:280,height:140,backgroundColor:"#b8dec0",sliceVisibilityThreshold:0},s=0!==parseFloat(e+t+i);s&&(this.gformat||(this.gformat=new google.visualization.NumberFormat({suffix:"g"})),this.gchart&&this.gchart.clearChart(),this.gchart=new google.visualization.PieChart(document.getElementById("gchart")),this.gformat.format(r,1),this.gchart.draw(r,a))},displayNutrition:function(){this.$nLabel.html(""),this.$nLabel.undelegate(),this.$nLabel.nutritionLabel(this.model.toJSON())},displayMenu:function(){var e=!1;this.$nutritionMenu.html(""),this.trackedItem&&(e=!0),this.$nutritionMenu.append(this.buttonsTemplate({tracking:e}))},addFood:function(){var e=new nt.Views.Editor({model:this.model});this.$nutrition.append(e.render().renderDatePicker().el)},removeFood:function(){var e=this.model.get("id"),t=nt.Collections.tracker.get(e);t.destroy(),this.trackedItem=null,this.displayMenu()},updateView:function(){var e=this.model.get("id"),t=nt.Collections.tracker.get(e).toJSON();this.model.set(t),this.displayNutrition(),this.trackedItem=!0,this.displayMenu()},openTrackerView:function(){this.closeNutrition(),$("#tab2").trigger("click")}}),nt.Views.Tracker=Backbone.View.extend({el:"#tracker",trackedTemplate:Handlebars.compile($("#tracked-template").html()),emptyMessage:"<p>No foods are being tracked.</p><p>Do a search and add something!</p>",emptyDate:"<p>There are no foods being tracked on this date.</p><p>Select another date or add a food.</p>",events:{"click #dtBack":"dateBack","click #dtForward":"dateForward","click #dtDisplay":"dateDisplay","click .options a":"setOption","click .tracked-delete":"deleteFood","click .tracked-edit":"openFood"},initialize:function(){_.bindAll(this,"sumCals","sumFat","sumCarbs","sumProt"),Handlebars.registerHelper({sumCals:this.sumCals,sumFat:this.sumFat,sumCarbs:this.sumCarbs,sumProt:this.sumProt,show:this.show}),this.$trackerResults=$("#tracker-results"),this.$dtp=$("#dtPicker"),this.listenTo(this.collection,"update",this.render),this.duration=moment.duration({days:1}),this.initDatePicker(),this.collection.fetch()},sumCals:function(){return this.collection.calculateSum("valueCalories")},sumFat:function(){return this.collection.calculateSum("valueTotalFat")},sumCarbs:function(){return this.collection.calculateSum("valueTotalCarb")},sumProt:function(){return this.collection.calculateSum("valueProteins")},show:function(e){var t=this.attributes.servingCount,i=0;return t>1?(i=e*t,Number.isInteger(i)?i:Number(i).toFixed(2)):e},render:function(){var e=$("#tracker").hasClass("active");nt.Option.displayAll?(this.renderAll(),e&&nt.Router.Instance.navigate("tracker/all")):(this.renderDate(),e&&nt.Router.Instance.navigate("tracker/date/"+nt.Option.trackerDate))},renderAll:function(){return this.$trackerResults.html(""),this.collection.length?this.$trackerResults.append(this.trackedTemplate(this.collection)):this.$trackerResults.html(this.emptyMessage),this},renderDate:function(){if(this.$trackerResults.html(""),this.collection.length){var e=this.collection.getModelsByDate();e.length?this.$trackerResults.append(this.trackedTemplate(e)):this.$trackerResults.html(this.emptyDate)}else this.$trackerResults.html(this.emptyMessage);return this},initDatePicker:function(){this.$dtp.datetimepicker({format:"MMMM D, YYYY",defaultDate:nt.Option.trackerDate,allowInputToggle:!0});var e=this;$("#dtPicker").on("dp.change",function(t){nt.Option.trackerDate=$(this).data("DateTimePicker").date().format("YYYY-MM-DD"),e.render()})},dateBack:function(){var e=this.$dtp.data("DateTimePicker").date(),t=e.subtract(this.duration);this.$dtp.data("DateTimePicker").date(t)},dateForward:function(){var e=this.$dtp.data("DateTimePicker").date(),t=e.add(this.duration);this.$dtp.data("DateTimePicker").date(t)},dateDisplay:function(){nt.Option.displayAll?($("#optAll").addClass("bold"),$("#optDate").removeClass("bold")):($("#optAll").removeClass("bold"),$("#optDate").addClass("bold"))},setOption:function(e){e.preventDefault();var t=$(e.target).attr("id");"optDate"===t?($("#tracker-top h5").show(),nt.Option.displayAll=!1):($("#tracker-top h5").hide(),nt.Option.displayAll=!0),this.render()},deleteFood:function(e){var t=$(e.target).data("id"),i=this.collection.get(t);i.destroy()},openFood:function(e){var t=$(e.target).closest(".tracked-row");nt.Views.nutrition.openNutrition(e),t.css("background-color","#b8dec0").addClass("highlight"),$(".tracked-delete").hide()}}),nt.Views.Editor=Backbone.View.extend({tagName:"div",className:"edit-item",editorTemplate:Handlebars.compile($("#editor-template").html()),servingsTemplate:$("#servings-template").html().trim(),count:1,events:{"click #foodSave":"saveFood","click #foodClose":"close","click #servingIncrease":"servingIncrease","click #servingDecrease":"servingDecrease"},initialize:function(){Handlebars.registerPartial("servings",this.servingsTemplate),this.createFood().listenTo(this.food,"change",this.updateView)},updateView:function(){var e=$("#dateTimePicker").data("DateTimePicker").date();$("#dateTimePicker").data("DateTimePicker").destroy(),this.render().renderDatePicker(),e&&this.$el.find("#dateTimePicker").data("DateTimePicker").date(e)},render:function(){return this.$el.html(this.editorTemplate(this.food.toJSON())),this},renderDatePicker:function(){return this.$el.find("#dateTimePicker").datetimepicker({format:"YYYY-MM-DD",allowInputToggle:!0,widgetPositioning:{horizontal:"right"}}),this},renderError:function(e){var t='<p class="bs-callout bs-callout-danger alert-danger"><i class="glyphicon glyphicon-exclamation-sign"></i> '+e+"</p>";this.$el.find("#editor-top").append(t)},removeError:function(){this.$el.find(".bs-callout").remove()},getFoodAttributes:function(){return this.model.toJSON()},userAttributes:function(){return{sortOrder:nt.Collections.tracker.nextOrder(),trackDate:this.$el.find("#foodTrackDate").val().trim(),itemName:this.$el.find("#foodName").val().trim(),servingCount:this.count,moreThanOne:this.count>1}},createFood:function(){var e=this.getFoodAttributes();this.food=new nt.Models.Nutrition,this.food.set(e);var t=this.food.get("servingCount");return t>1&&(this.count=t,this.food.valueUpdate(e,t)),this},saveFood:function(e){e.preventDefault(),this.removeError(),this.count>1&&this.food.valueUpdate(this.getFoodAttributes(),1);var t=this.userAttributes();this.food.set(t,{validate:!0});var i=this.food.validationError;i?this.renderError(i):(nt.Collections.tracker.create(this.food,{merge:!0}),this.model.trigger("foodsaved"),this.close())},close:function(){$("#dateTimePicker").data("DateTimePicker").destroy(),this.remove()},servingIncrease:function(){this.count>=1&&this.count++,this.food.valueUpdate(this.getFoodAttributes(),this.count)},servingDecrease:function(){this.count>=2&&this.count--,this.food.valueUpdate(this.getFoodAttributes(),this.count)}}),nt.Router=Backbone.Router.extend({routes:{start:"start",search:"startSearch","search/:query":"search","tracker/:display(/:date)":"tracker"},"goto":function(e){nt.Router.Instance.navigate(e,{trigger:!0})},start:function(){nt.Views.start.showStart()},startSearch:function(){var e=$("#search").hasClass("active");e||$("#tab1").trigger("click"),nt.Views.start.hideStart(),nt.Views.search.$searchFood.val(""),nt.Views.search.$searchResults.html("")},search:function(e){var t=$("#search").hasClass("active");t||$("#tab1").trigger("click"),nt.Views.start.hideStart(),nt.Views.search.$searchFood.val(e),nt.Views.search.searchFood(),nt.Plugin.Instance.hide()},tracker:function(e,t){nt.Views.start.hideStart();var i=$("#tracker").hasClass("active");if(i||$("#tab2").trigger("click"),"all"===e)$("#tracker-top h5").hide(),nt.Option.displayAll=!0,nt.Views.tracker.$dtp.data("DateTimePicker").date(moment(new Date));else if("date"===e&&t.length>0){var r=moment(t).format("MMMM D, YYYY");$("#tracker-top h5").show(),nt.Option.displayAll=!1,nt.Option.trackerDate=t,nt.Views.tracker.$dtp.data("DateTimePicker").date(r)}nt.Views.tracker.dateDisplay()}}),$(document).ready(function(){nt.Router.Instance=new nt.Router,nt.Models.nutrition=new nt.Models.Nutrition,nt.Collections.suggest=new nt.Collections.AutocompleteSearch,nt.Collections.results=new nt.Collections.FoodSearch,nt.Collections.recipes=new nt.Collections.RecipeSearch,nt.Collections.tracker=new nt.Collections.NutritionTracker,nt.Plugin.Typeahead=Backbone.Typeahead.extend({template:$("#search-template").html()}),nt.Plugin.Instance=new nt.Plugin.Typeahead({collection:nt.Collections.suggest,key:"text"}),nt.Plugin.Instance.setElement("#search-suggest").render(),nt.Views.start=new nt.Views.Start,nt.Views.tabs=new nt.Views.TabNav,nt.Views.search=new nt.Views.Search({collection:nt.Collections.results}),nt.Views.recipe=new nt.Views.Recipe({collection:nt.Collections.recipes}),nt.Views.nutrition=new nt.Views.Nutrition({model:nt.Models.nutrition}),nt.Views.tracker=new nt.Views.Tracker({collection:nt.Collections.tracker}),Backbone.history.start(),nt.Router.Instance["goto"]("start")});