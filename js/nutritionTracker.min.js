/**! Nutrition Tracker App
 * @namespace {object} nt */
var nt={Models:{},Collections:{},Views:{},Router:{},Plugin:{},preloader:'<div class="spinnerContainer">Loading <div class="spinner"></div> Please Wait'};nt.Models.Food=Backbone.Model.extend({defaults:{id:"",sortOrder:0,name:"",fat:0,carbs:0,protein:0,calories:0,servingSize:0,servingUnit:""},parse:function(e){if("undefined"!=typeof e.fields){var t={};return t.id=e._id,t.name=e.fields.item_name,t.calories=e.fields.nf_calories,t.fat=e.fields.nf_total_fat,t.carbs=e.fields.nf_total_carbohydrate,t.protein=e.fields.nf_protein,t.servingSize=e.fields.nf_serving_size_qty,t.servingUnit=e.fields.nf_serving_size_unit,t}return e}}),nt.Models.Recipe=Backbone.Model.extend({defaults:{id:"",recipeImage:"",recipeTitle:"",numCalories:"",numIngredients:"",siteIcon:"",siteTitle:"",siteLink:""},parse:function(e){var t=e.recipe.uri.indexOf("_")+1,i="http://www.edamam.com/http/",n="images/icon.png";e.recipe.sourceIcon&&(n=e.recipe.sourceIcon.replace("http://",i));var s={};return s.id=e.recipe.uri.slice(t),s.recipeImage=e.recipe.image,s.recipeTitle=e.recipe.label,s.numCalories=parseInt(e.recipe.calories/e.recipe["yield"],10),s.numIngredients=e.recipe.ingredientLines.length,s.siteIcon=n,s.siteTitle=e.recipe.source,s.siteLink=e.recipe.shareAs,s}}),nt.Models.Nutrition=Backbone.Model.extend({defaults:function(){return{width:280,id:"",itemName:"",showPolyFat:!1,showMonoFat:!1,showIngredients:!1,valueServingSize:0,valueServingSizeUnit:"",valueCalories:0,valueFatCalories:0,valueTotalFat:0,valueSatFat:0,valueTransFat:0,valueCholesterol:0,valueSodium:0,valueTotalCarb:0,valueFibers:0,valueSugars:0,valueProteins:0,valueVitaminA:0,valueVitaminC:0,valueCalcium:0,valueIron:0}},url:"https://api.nutritionix.com/v1_1/item/",parse:function(e){if(e.hasOwnProperty("item_id")){var t={};return t.width=280,t.id=e.item_id,t.itemName=e.item_name,t.showPolyFat=!1,t.showMonoFat=!1,t.showIngredients=!1,t.valueServingSize=e.nf_serving_size_qty,t.valueServingSizeUnit=e.nf_serving_size_unit,t.valueCalories=e.nf_calories,t.valueFatCalories=e.nf_calories_from_fat,t.valueTotalFat=e.nf_total_fat,t.valueSatFat=e.nf_saturated_fat,t.valueTransFat=e.nf_trans_fatty_acid,t.valueCholesterol=e.nf_cholesterol,t.valueSodium=e.nf_sodium,t.valueTotalCarb=e.nf_total_carbohydrate,t.valueFibers=e.nf_dietary_fiber,t.valueSugars=e.nf_sugars,t.valueProteins=e.nf_protein,t.valueVitaminA=e.nf_vitamin_a_dv,t.valueVitaminC=e.nf_vitamin_c_dv,t.valueCalcium=e.nf_calcium_dv,t.valueIron=e.nf_iron_dv,t}return e}}),nt.Models.Autocomplete=Backbone.Model.extend({defaults:{id:"",text:""}}),nt.Collections.FoodSearch=Backbone.Collection.extend({model:nt.Models.Food,searchPhrase:"",url:function(){return"https://api.nutritionix.com/v1_1/search/"+this.searchPhrase},parse:function(e){return e.hits},nextOrder:function(){return this.length?this.last().get("sortOrder")+1:1},comparator:function(e){return e.get("sortOrder")}}),nt.Collections.RecipeSearch=Backbone.Collection.extend({model:nt.Models.Recipe,url:"https://api.edamam.com/search",sync:function(e,t,i){return i.dataType="jsonp",Backbone.sync(e,t,i)},parse:function(e){return e.hits}}),nt.Collections.NutritionTracker=Backbone.Collection.extend({model:nt.Models.Nutrition,localStorage:new Backbone.LocalStorage("nutrition-tracker"),nextOrder:function(){return this.length?this.last().get("sortOrder")+1:1},comparator:function(e){return e.get("sortOrder")}}),nt.Collections.AutocompleteSearch=Backbone.Collection.extend({model:nt.Models.Autocomplete,url:"https://apibeta.nutritionix.com/v2/autocomplete",api:{q:"",appId:"53242d79",appKey:"82289438a16ec7b92cdcf5ad054159c4"},apiError:function(e,t){var i=t.status+" "+t.statusText+" : Autocomplete server request error";window.console&&console.log(i),$("#search-suggest .dropdown-menu").show().prepend('<li class="typeahead-error"><a>'+i+"</a></li>"),e.reset()},fetch:function(){return this.trigger("fetch",this),Backbone.Model.prototype.fetch.apply(this,arguments)}}),nt.Views.Start=Backbone.View.extend({el:"#start-screen",events:{"click .btn-success":"removeStart"},removeStart:function(){this.remove(),nt.Router.Instance.navigate("search"),$("#app").show()}}),nt.Views.TabNav=Backbone.View.extend({initialize:function(){$("#app-tabs a").click(function(e){e.preventDefault(),$(this).tab("show"),$(".row").eqHeights({child:".eqHeights"})})}}),nt.Views.Search=Backbone.View.extend({el:"#search-top",prevQuery:"",itemTemplate:Handlebars.compile($("#item-template").html()),events:{"click #search-help":"toggleHelp","click #search-help-text .close":"toggleHelp"},initialize:function(){_.bindAll(this,"searchSuccess","searchError"),this.$searchTop=$("#search-top"),this.$searchResults=$("#search-results"),this.$searchFood=$("#search-food"),this.$help=$("#search-help-text"),this.$dropmenu=$("#search-suggest .dropdown-menu"),this.listenTo(nt.Plugin.Instance,"selected",this.searchFood)},render:function(){return this.$searchResults.html(""),this.$searchResults.append(this.itemTemplate({items:this.collection.toJSON()})),this},toggleHelp:function(){this.$help.toggle()},renderNoResults:function(){var e=this.$searchFood.val(),t='<div class="alert alert-info">Could not find any foods containing: '+e+"</div>";this.$searchResults.html(t)},searchSuccess:function(e,t){0===t.total_hits?this.renderNoResults():this.render()},searchError:function(e,t){var i=t.status,n=t.statusText,s='<div class="alert alert-danger">Nutritionix search request failed with error: <br>'+i+" : "+n+"</div>";this.$searchResults.html(s)},searchFood:function(e){var t=this.$searchFood.val().trim(),i={results:"0:10",fields:"item_name,nf_calories,nf_total_fat,nf_total_carbohydrate,nf_protein,nf_serving_size_qty,nf_serving_size_unit",appId:"53242d79",appKey:"82289438a16ec7b92cdcf5ad054159c4"};return t.length>0&&t!==this.prevQuery?(this.collection.reset(),this.collection.searchPhrase=t,this.collection.fetch({data:$.param(i),success:this.searchSuccess,error:this.searchError})):this.$searchResults.html(""),this.prevQuery=t,nt.Router.Instance["goto"]("search/"+t),!1}}),nt.Views.Recipe=Backbone.View.extend({el:"#search",recipeTemplate:Handlebars.compile($("#recipe-template").html()),events:{"click #recipe-open":"openRecipes","click #recipe-close":"closeRecipes"},initialize:function(){_.bindAll(this,"recipeSuccess","recipeError"),this.$searchTop=$("#search-top"),this.$searchResults=$("#search-results"),this.$recipeTop=$("#recipe-top"),this.$recipeResults=$("#recipe-results"),this.$recipeResults.html(nt.preloader)},render:function(){return this.$recipeResults.html(""),this.$recipeResults.append(this.recipeTemplate({recipes:this.collection.toJSON()})),this},recipeSuccess:function(e,t){this.render()},recipeError:function(e,t){var i=t.status,n=t.statusText,s='<div class="alert alert-danger">Edamam recipe request failed with error: <br>'+i+" : "+n+"</div>";this.$recipeResults.html(s)},getRecipes:function(e){var t={q:e,app_id:"109142f6",app_key:"21467cc06c5f05e55b19271dcc457914",to:"5"};this.collection.reset(),this.collection.fetch({data:$.param(t),success:this.recipeSuccess,error:this.recipeError})},openRecipes:function(){var e=$("#search-food").val();this.getRecipes(e),this.$searchTop.hide(),this.$searchResults.hide(),this.$recipeTop.show(),this.$recipeResults.show()},closeRecipes:function(){this.$recipeResults.html(""),this.$recipeTop.hide(),this.$searchTop.show(),this.$recipeResults.hide(),this.$searchResults.show()}}),nt.Views.Nutrition=Backbone.View.extend({el:"#app",buttonsTemplate:Handlebars.compile($("#buttons-template").html()),events:{"click .item-nutrition":"openNutrition","click #nutrition-close":"closeNutrition","click #nutrition-add":"addFood","click #nutrition-remove":"removeFood","click #nutrition-track":"openTrackerView"},initialize:function(){_.bindAll(this,"itemSuccess","itemError"),this.$nutrition=$("#nutrition"),this.$nutritionTop=$("#nutrition-top"),this.$nutritionMenu=$("#nutrition-button-menu"),this.$nutritionResults=$("#nutrition-results"),this.$nLabel=$("#nlabel"),this.trackedItem=null,this.gchart=null,this.gformat=null,google.charts.load("current",{packages:["corechart"]}),this.listenTo(nt.Plugin.Instance,"selected",this.closeNutrition),this.listenTo(this.model,"foodsaved",this.showTracking)},render:function(){this.displayMenu(),this.displayChart(),this.displayNutrition()},showColumn:function(){this.$nutrition.removeClass("hideColumn")},hideColumn:function(){this.$nutrition.addClass("hideColumn")},openNutrition:function(e){var t=$(e.target),i=t.data("item");e.preventDefault(),this.closeNutrition(),t.closest(".item").css("background-color","#b8dec0").addClass("highlight"),this.showColumn(),this.checkItem(i)},checkItem:function(e){this.trackedItem=nt.Collections.tracker.get(e),this.trackedItem?(this.model.set(this.trackedItem.toJSON()),this.itemSuccess()):this.getNutrition(e)},closeNutrition:function(){$(".highlight").removeAttr("style").removeClass("highlight"),this.$nutritionResults.find("figure").html(""),this.hideColumn(),$(".tracked-delete").show()},itemSuccess:function(e,t){this.render(),$(".row").eqHeights({child:".eqHeights"})},itemError:function(e,t){var i=t.status,n=t.statusText,s='<div class="alert alert-danger">Nutritionix item request failed: <br>'+i+" : "+n+"</div>";this.$nutritionMenu.html(s)},getNutrition:function(e){var t={id:e,appId:"53242d79",appKey:"82289438a16ec7b92cdcf5ad054159c4"};this.$nutritionMenu.html(nt.preloader),this.model.clear(),this.model.fetch({data:$.param(t),success:this.itemSuccess,error:this.itemError})},displayChart:function(){var e=this.model.get("valueTotalFat"),t=this.model.get("valueTotalCarb"),i=this.model.get("valueProteins"),n=google.visualization.arrayToDataTable([["Nutrient","Value"],["Fat",e],["Carbs",t],["Protein",i]]),s={width:280,height:140,backgroundColor:"#b8dec0",sliceVisibilityThreshold:0},r=0!==parseFloat(e+t+i);r&&(this.gformat||(this.gformat=new google.visualization.NumberFormat({suffix:"g"})),this.gchart&&this.gchart.clearChart(),this.gchart=new google.visualization.PieChart(document.getElementById("gchart")),this.gformat.format(n,1),this.gchart.draw(n,s))},displayNutrition:function(){this.$nLabel.nutritionLabel(this.model.toJSON())},displayMenu:function(){var e=!1;this.$nutritionMenu.html(""),this.trackedItem&&(e=!0),this.$nutritionMenu.append(this.buttonsTemplate({tracking:e}))},addFood:function(){var e=new nt.Views.Editor({model:this.model});this.$nutrition.append(e.render().el)},removeFood:function(){var e=this.model.get("id"),t=nt.Collections.tracker.get(e);t.destroy(),this.trackedItem=null,this.displayMenu()},showTracking:function(){this.trackedItem=!0,this.displayMenu()},openTrackerView:function(){this.closeNutrition(),$("#tab2").trigger("click")}}),nt.Views.Tracker=Backbone.View.extend({el:"#tracker",trackedTemplate:Handlebars.compile($("#tracked-template").html()),emptyMessage:"<p>No foods are being tracked.</p><p>Do a search and add something!</p>",events:{"click .tracked-delete":"deleteFood","click .tracked-edit":"openFood"},initialize:function(){this.$trackerResults=$("#tracker-results"),this.listenTo(this.collection,"update",this.render),this.collection.fetch()},render:function(){return this.$trackerResults.html(""),this.collection.length?this.$trackerResults.append(this.trackedTemplate(this.collection)):this.$trackerResults.html(this.emptyMessage),this},deleteFood:function(e){var t=$(e.target).data("id"),i=this.collection.get(t);i.destroy()},openFood:function(e){var t=$(e.target).closest(".tracked-row");nt.Views.nutrition.openNutrition(e),t.css("background-color","#b8dec0").addClass("highlight"),t.find("td:last .tracked-delete").hide()}}),nt.Views.Editor=Backbone.View.extend({tagName:"div",className:"edit-item",editorTemplate:Handlebars.compile($("#editor-template").html()),events:{"click #foodSave":"saveFood","click #foodClose":"close"},initialize:function(){var e=new Date;this.today=new Date(e.getTime()-6e4*e.getTimezoneOffset()).toJSON().slice(0,10),this.$inputDate=$("#foodTrackDate"),this.createFood()},render:function(){return this.$el.html(this.editorTemplate(this.food.toJSON())),this},newAttributes:function(){return{sortOrder:nt.Collections.tracker.nextOrder(),trackDate:this.$inputDate.val()}},createFood:function(){this.food=new nt.Models.Nutrition,this.food.set(this.model.toJSON()),this.food.set({trackDate:this.today})},saveFood:function(e){e.preventDefault();var t=this.newAttributes();this.food.set(t),nt.Collections.tracker.add(this.food),this.food.save(),this.model.trigger("foodsaved"),this.close()},close:function(){this.remove()}}),nt.Router=Backbone.Router.extend({routes:{"":"start","search/:query":"search","tracker/:id":"tracker"},"goto":function(e){console.log("ROUTER: goto -> "+e),nt.Router.Instance.navigate(e,{trigger:!0})},search:function(e){console.log("ROUTER: Food search containing the word: "+e)},tracker:function(e){console.log("ROUTER: Tracker item selected with id: "+e)}}),$(document).ready(function(){nt.Models.nutrition=new nt.Models.Nutrition,nt.Collections.suggest=new nt.Collections.AutocompleteSearch,nt.Collections.results=new nt.Collections.FoodSearch,nt.Collections.recipes=new nt.Collections.RecipeSearch,nt.Collections.tracker=new nt.Collections.NutritionTracker,nt.Plugin.Typeahead=Backbone.Typeahead.extend({template:$("#search-template").html()}),nt.Plugin.Instance=new nt.Plugin.Typeahead({collection:nt.Collections.suggest,key:"text"}),nt.Plugin.Instance.setElement("#search-suggest").render(),nt.Views.start=new nt.Views.Start,nt.Views.tabs=new nt.Views.TabNav,nt.Views.search=new nt.Views.Search({collection:nt.Collections.results}),nt.Views.recipe=new nt.Views.Recipe({collection:nt.Collections.recipes}),nt.Views.nutrition=new nt.Views.Nutrition({model:nt.Models.nutrition}),nt.Views.tracker=new nt.Views.Tracker({collection:nt.Collections.tracker}),nt.Router.Instance=new nt.Router,Backbone.history.start(),nt.Router.Instance.navigate("start")});